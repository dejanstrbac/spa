(function(e,t,n){n.fn.spa=n.fn.spa||function(){var r=2.12,i=function(){return"onhashchange"in e&&(t.documentMode===undefined||t.documentMode>7)}(),s="handler",o=10,u=[],a=null,f=700,l=20,c=this,h=null,p=null,d=333,v=[],m={},g={},y=null,b={},w=false,E=false,S=function(){if(e.location.hash&&e.location.hash!=="#"){return e.location.hash}else{return"#!/"}},x=function(e,t){var n=function(e,t){return function(){var n=t.apply(this,arguments),r=e.apply(this,arguments);return n||r}},r=null;for(r in t){if(t.hasOwnProperty(r)){if(e.hasOwnProperty(r)){e[r]=n(e[r],t[r])}else{e[r]=t[r]}}}},T=function(e){if(w&&typeof console!=="undefined"&&console.log){console.log("(spa) "+e)}},N=function(e,t,n,r,i){var s=null;if(typeof r==="undefined"){r=true}if(r){t=t.toString();e=e.toString();if(!b.hasOwnProperty(e)){b[e]={}}if(!b[e].hasOwnProperty(t)){T("mem miss: "+e+"["+t+"]");if(n){s=n(t);if(typeof i==="undefined"||i&&i(s)){b[e][t]=s}return s}}else{T("mem hit: "+e+"["+t+"]");return b[e][t]}}else{if(b.hasOwnProperty(e)&&b[e].hasOwnProperty(t)){delete b[e][t]}if(n){return n(t)}}},C=function(e,t){if(y){return y(e,t)}else{var n;for(n in t){if(t.hasOwnProperty(n)){e=e.replace(new RegExp("{{"+n+"}}","g"),t[n])}}return e}},k=function(t,n){if(typeof n==="undefined"){T("redirecting page: "+t);e.location.hash="#!"+t;h=null}else{e.location=n+(t||"")}},L=function(t){var n=t||e.location.hash,r={},i=null,s=null;if(n.match(/^\#\!/)){i=n.substr(3).split("/");while(i.length!==0){s=i.splice(0,2);r[s[0]]=s[1]}}return r},A=function(e){var t=null,n,r;if(e.match(/^$|^#(?!\!).+/)){t=v.slice(-1)[0]}else if(e.match(/^\#\!.+/)){for(n=0,r=v.length;n<r&&!t;n+=1){if(RegExp(v[n].url).test(e.slice(2))){t=v[n]}}}return t},O=function(e){return N("spa__responses",e.path,function(){return m[e.controller][e.action](e)},true,function(e){return e&&e.hasOwnProperty("options")&&!!e.options.cache})},M=function(e,t,n){if(m[t.controller][e]){setTimeout(function(){m[t.controller][e].call(null,t,n)},0);T("callback "+t.controller+"."+e+"()")}if(g[e]){setTimeout(function(){g[e].call(null,t,n)},0);T("callback "+e+"()")}},_=function(e,t){var n=e.controller;if(t.options&&t.options.template){n=t.options.template}else if(e.action){n+="__"+e.action}return n},D=function(e){var t=N("spa__templates",e.options.template),n=null,r=null;e.data=e.data||{};e.options=e.options||{};if(e.options.cache){if(e.options.cache===true){r=e.options.template}else{r=e.options.template+"-"+e.options.cache}}n=N("spa__views",r,function(){var n=null;if(t){n=C(t,e.data);if(n){return'<div id="spa__wrap">'+n+"</div>"}else{throw new Error("template error >> "+e.options.template)}}else{throw new Error("template not found >> "+e.options.template)}},r!==null);return n},P=function(e,t){e=e.replace(/<[iI][mM][gG]/g,'<br class="spa-image-preloading"');if(!n.isNumeric(t)){t=o}n.each(n(e).find("br.spa-image-preloading").slice(0,t),function(){var e=n(this).attr("src");n("<img/>")[0].src=e;T("preload image: "+e)})},H=function(e){var t=A(e),n=S(),r=null,i=null;if(t){r={path:e,previousPath:n,params:L(e),previousParams:L(n),controller:t.controller,action:t.action||s};response=O(r);repsonse.options=response.options||{};if(!response.options.renderNothing){response.options.template=_(r,response);i=D(response);if(response.options.preloadImages){P(i,response.options.preloadImages)}}T("preload path done: "+e)}},B=function(e){var t=[];e.find("a").each(function(){var e=n(this).attr("href");if(e&&!n(this).hasClass(".spa-no-preload")&&e.lastIndexOf("#!/",0)===0&&n.inArray(e,t)===-1){u.push(e);if(u.length>l){u.shift()}t.push(e)}});return t},j=function(e,t){var n=null;if(u.length){n=u.pop();if(n){T("\n ~~~ \npreload stack pop ("+u.length+"): "+n);H(n)}}else{T("preload stack empty");clearInterval(a);a=null;M("afterPreload",e,t)}},F=function(){var t=S(),n=true,r=null,i=null,o=null;if(n&&t!==h){n=false;r=A(t);if(!r){c.empty().html(D({options:{template:"404",cache:true}}))}else{i={path:t,previousPath:h,params:L(t),previousParams:p,controller:r.controller,action:r.action||s};M("beforeFilter",i);o=O(i);M("afterFilter",i,o);if(o){o.options=o.options||{};if(o.options.renderNothing){T("template bypassed")}else{M("beforeRender",i,o);o.options.template=_(i,o);c.empty().html(D(o));M("afterRender",i,o);if(o.options.preloadPaths){o.preloadedPaths=N("spa__preloaded_paths",i.path,function(){var e=B(c);if(!a){a=setInterval(function(){j(i,o)},o.options.preloadStackDelay||f)}return e})}setTimeout(function(){e.scrollTo(0,0)},0)}if(o.options.redirectTo){k(o.options.redirectTo)}}else{c.empty().html(D({options:{template:"404",cache:true}}))}p=i.params;h=t;n=true}}},I=function(){if(!E){E=true;if(i){n(e).on("hashchange",F)}else{setInterval(F,d)}F();return E}else{return false}};if(!c.length){throw new Error("container does not exist")}n("script[type='text/html']").map(function(e,t){var r=n(t),i=r.attr("id");if(i.substr(0,5)==="spa__"){i=i.substring(5);N("spa__templates",i,function(){return r.html()})}});return{helpers:{getTemplate:function(e){return N("spa__templates",e)},getMemoized:function(e,t,n,r,i){return N(e,t,n,r,i)},redirectTo:k,render:C},isRunning:function(){return E},setDebug:function(e){if(e!=="undefined"){w=e}T("jQuery SPA (Single Page App) v"+r);T("https://github.com/dejanstrbac/spa");T("~~~~ ~~~ ~~~ ~~~ ~~~ ~~~~ ~~~~ ~~~");T("Debug mode enabled");return w},setRenderer:function(e){y=e},addHelpers:function(e){x(this.helpers,e)},addControllers:function(e){var t;for(t in e){if(e.hasOwnProperty(t)){m[t]=m[t]||{};x(m[t],e[t])}}},addCallbacks:function(e){x(g,e)},addRoutes:function(e){v=v.concat(e)},run:function(){return I()}}}})(window,document,$)
