var Spa=Spa||function(e){"use strict";var t=3.2,n=typeof e==="undefined"?{}:e,r="handler",i=document.getElementById(n.containerId)||document.createElement("DIV"),s,o,u,a,f=n.pollingInterval||200,l=n.routes||[],c=n.controllers||{},h=n.callbacks||{},p={},d={},v=n.templateEngine,m=n.debug||false,g,y=function(){var e=function(e,t){for(var n=0,r=e.length;n<r;n+=1){t(e[n],n)}},t=function(e,t){return function(){var n=t.apply(this,arguments);if(n!==false){n=n||e.apply(this,arguments)}return n}},n=function(e,n){for(var r in n){if(n.hasOwnProperty(r)){if(e.hasOwnProperty(r)){e[r]=t(e[r],n[r])}else{e[r]=n[r]}}}},r=function(e,t,n){if(e.addEventListener){e.addEventListener(t,n)}else{e.attachEvent("on"+t,function(){n.call(e)})}},i=function(e){if(document.addEventListener){document.addEventListener("DOMContentLoaded",e)}else{document.attachEvent("onreadystatechange",function(){if(document.readyState==="interactive"){e()}})}},s=function(){return"onhashchange"in window&&(document.documentMode===undefined||document.documentMode>7)}(),o=function(){return window.location.hash&&window.location.hash!=="#"?window.location.hash:"#!/"},u=function(e,t){for(var n in t){if(t.hasOwnProperty(n)){e=e.replace(new RegExp("{{"+n+"}}","g"),t[n])}}return e},a=function(e,t){if(typeof console!=="undefined"&&console.log){console.log(u(e,t))}};return{each:e,extendMethods:n,addEventListener:r,onDocumentReady:i,debugLog:a,hashChangeSupported:s,getLocationHash:o,interpolate:u}}(),b=function(e){if(m){y.debugLog("Spa: {{debugMessage}}",{debugMessage:e})}},w=function(e){var t=function(t,n,r,i,s){var o;if(!e){e={}}if(typeof i==="undefined"){i=true}if(i){n=n.toString();t=t.toString();if(!e.hasOwnProperty(t)){e[t]={}}if(!e[t].hasOwnProperty(n)){b("memo miss: "+t+"["+n+"]");if(r){if(typeof r==="function"){o=r(n)}else{o=r}if(typeof s==="undefined"||s&&s(o)){b("memo write: "+t+"["+n+"]");e[t][n]=o}return o}}else{b("memo hit: "+t+"["+n+"]");return e[t][n]}}else{if(e.hasOwnProperty(t)&&e[t].hasOwnProperty(n)){delete e[t][n]}if(r){return r(n)}}},n=function(t,n){return e.hasOwnProperty(t)&&e[t].hasOwnProperty(n)};return{memoize:function(e,n,r,i,s){return t(e,n,r,i,s)},isMemoized:function(e,t){return n(e,t)}}},E=function(e,t){if(typeof t==="undefined"){b("redirected to: "+e);window.location.hash="#!"+e;a=null}else{window.location=t+(e||"")}},S=function(e){var t=e||window.location.hash,n={},r,i;if(t.match(/^\#\!/)){r=t.substr(3).split("/");while(r.length!==0){i=r.splice(0,2);n[i[0]]=i[1]}}return n},x=function(e){var t,n,r;if(e.match(/^$|^#(?!\!).+/)){t=l.slice(-1)[0]}else if(e.match(/^\#\!.+/)){for(n=0,r=l.length;n<r&&!t;n+=1){if((new RegExp(l[n].url)).test(e.slice(2))){t=l[n]}}}return t},T=function(e){return _.memoize("spa__responses",e.path,function(){return c[e.controller][e.action](e)},true,function(e){return e&&e.hasOwnProperty("options")&&!!e.options.cache})},N=function(e,t,n){var r=c[t.controller][e],i=h[e];if(r){b("callback: "+t.controller+"."+e+"()");setTimeout(function(){r.call(null,t,n)},5)}if(h[e]){b("callback: "+e+"()");setTimeout(function(){i.call(null,t,n)},5)}},C=function(e,t){var n=e.controller;if(t.options&&t.options.hasOwnProperty("templateName")){n=t.options.templateName}else if(e.action){n+="__"+e.action}return n},k=function(e,t){var n=new XMLHttpRequest;b("remote template requested: "+e+".spa.html");n.open("GET",e+".spa.html",true);n.onreadystatechange=function(){if(this.readyState===4){if(this.status>=200&&this.status<400){if(typeof t!=="undefined"){t(e,this.responseText);b("remote template retrieved: "+e+".spa.html")}}else{throw new Error("remote template not found >> "+e)}}};n.send();n=null},L=function(e,t){var n;if(v){n=v(e,t)}else{n=y.interpolate(e,t)}if(!n){throw new Error("template error >> "+u.options.template)}return n},A=function(e){if(s){i.removeChild(s)}s=document.createElement("DIV");s.innerHTML=e;i.appendChild(s)},O=function(e){var t=_.memoize("spa__templates",e.options.template),n,r;e.data=e.data||{};e.options=e.options||{};if(!t){throw new Error("template not found >> "+e.options.template)}if(e.options.cache){r=e.options.template;if(e.options.cache!==true){r+="-"+e.options.cache}n=_.memoize("spa__views",r,function(){return L(t,e.data)})}else{n=L(t,e.data)}A(n)},M=function(){var e=y.getLocationHash(),t=true,n;if(t&&e!==a){t=false;n=x(e);if(!n){O({options:{template:"404",cache:true}})}else{b("---");if(o){N("beforeUnload",o,u)}o={path:e,params:S(e),controller:n.controller,action:n.action||r,previous:o};N("beforeFilter",o);u=T(o);N("afterFilter",o,u);if(u){u.options=u.options||{};if(u.options.renderNothing){b("template bypassed")}else{N("beforeRender",o,u);u.options.template=C(o,u);if(u.options.remoteTemplate&&!_.isMemoized("spa__templates",u.options.templateName)){k(u.options.templateName,function(e,t){_.memoize("spa__templates",e,t);O(u);N("afterRender",o,u)})}else{O(u);N("afterRender",o,u)}setTimeout(function(){window.scrollTo(0,0)},0)}if(u.options.redirectTo){E(u.options.redirectTo)}}else{O({options:{template:"404",cache:true}})}a=e;t=true}}},_=w(p),D=function(){var e=document.querySelectorAll("script[type='text/html']");if(!g){if(!i){throw new Error("container does not exist")}document.body.appendChild(i);y.each(e,function(e){var t=e.id;if(t.substr(0,5)==="spa__"){t=t.substring(5);_.memoize("spa__templates",t,function(){return e.innerHTML})}});g=true;M();if(y.hashChangeSupported){y.addEventListener(window,"hashchange",M)}else{setInterval(M,f)}}};return{helpers:{getTemplate:function(e){return _.memoize("spa__templates",e)},redirectTo:function(e,t){return E(e,t)},render:function(e,t){return L(e,t)},cache:w(d)},setDebug:function(e){if(e!=="undefined"){m=e}b("SPA (Single Page App) v"+t);b("https://github.com/dejanstrbac/spa");b("~~~~ ~~~ ~~~ ~~~ ~~~ ~~~~ ~~~~ ~~~");b("Debug mode enabled")},setTemplateEngine:function(e){v=e},addHelpers:function(e){y.extendMethods(this.helpers,e)},addControllers:function(e){for(var t in e){if(e.hasOwnProperty(t)){c[t]=c[t]||{};y.extendMethods(c[t],e[t])}}},addCallbacks:function(e){y.extendMethods(h,e)},addRoutes:function(e){l=l.concat(e);return l},start:function(){y.onDocumentReady(D);return g}}}
